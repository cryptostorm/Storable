<div id="listing-page-container" style="min-width: 870px;">
	<div id="sub-wrapper" style="margin: auto; min-width: 870px">
		<div id="top-left" style="float: left; width: 206px; display: margin-right: 20px">
			<a href='<%= user_path(@listing.user) %>' style="color: #fff; text-decoration: none;" >
				<div id="pphoto" class="pphoto" style="background-image: url('<%= @listing.user.profile_photo %>');">
					<div class="image-heading" style="display: none;">
						<%= @listing.user.pretty_name %>
					</div>
				</div>
			</a>

			<% if @current_user && @listing.user.id != @current_user.id %>
				<div id="message-lister" class="abutton" style="text-align: center; font-size: 14px; border-radius: 0; border-radius 3px">
					Message <%= @listing.user.email %>
				</div>
				<div id="rent-listing" class="abutton" style="text-align: center; font-size: 14px; border-radius: 0; border-radius 3px">
					Rent Me!
				</div>
			<% elsif !@current_user %>
				<div class="abutton" style="text-align: center; font-size: 14px; border-radius: 0"> Sign up to rent this space! </div>

			<% else %>
					<a class="abutton" style="text-align: center; font-size: 14px; border-radius: 0; display: block; margin-top: 18px;" 
					href=<%= edit_listing_path(@listing) %>>
						Edit Listing
					</a>
			<% end %>
		</div>

		<div id="listing-images-container" style="float: left; width: 600px; height: 251px; margin: 0 0 0 30px;" class="profile-section-wrapper">

			<div class="header" style="margin: 4px 10px 10px 10px">
				<%= @listing.title %>	
			</div>

			<div style="overflow-y:hidden; overflow-x: scroll; width: 580px; height: 212px; margin: 10px 0 0 10px">
				<div id="listing-images" style="float: left; width: <%= @listing.images.count * 220 %>px; overflow-y: hidden; overflow-x: scroll;">
					<% @listing.images.each do |image| %>
						<div class="listing-image">
							<img style="width: 200px; height:200px; padding: 1px; cursor: pointer;" src="<%= image.location %>" href='<%= image.location %>' class="fancybox"></img>
						</div>
					<% end %>
				</div>
			</div>
		</div>

		<div class="clearfix"></div>
		<div id="profile-stats-container" style="float: left; width: 206px; font-size: 14px;">

			<div id="host-stats" class="profile-section-wrapper" style="height: 200px; margin: 20px 0 0 0px; width: 206px;">
				<div class="header">Host Stats</div>
				<ul id="host-stats-list">
					<li>Hosted: 0</li>
					<li>Late Returns: 0</li>
					<li>Overall Rating: 0/5</li>
					<li>Timeliness Rating: 0/5</li>
					<li>Responsiveness Rating: 0/5</li>
					<li>Quality Rating: 0/5</li>
				</ul>
			</div>

			<div id="renter-stats" class="profile-section-wrapper" style="height: 200px; margin: 20px 0 0 0px; width: 206px;">
				<div class="header">Renter Stats</div>
				<ul id="renter-stats-list">
					<li>Rented: 0</li>
					<li>Late Pick-Ups: 0</li>
					<li>Overall Rating: 0/5</li>
					<li>Timeliness Rating: 0/5</li>
					<li>Responsiveness Rating: 0/5</li>
					<li>Quality Rating: 0/5</li>
				</ul>
			</div>
		</div>
		<div id="listing-info-wrapper" style="max-width: 600; float: left;">
			<div id="listing-detail" style="width: 580px; margin: 20px 0 0 30px; padding: 2px 10px 10px 10px; height: 260px" class="profile-section-wrapper-custom">
				<div class="header">Description</div>
				<section class="profile-section-content">
					<div id="listing-detail-details">
						Price per month: <%= @listing.price %> <br />
						Size: <%= @listing.size %> <br />
						Available from <%= @listing.start_date.strftime("%B %d %Y")+" to "+@listing.end_date.strftime("%B %d %Y") %>
					</div>
					<div id="listing-detail-description" style="height: 178px; overflow-y: scroll; margin-top: 5px;">
						<%= @listing.description %>
					</div>
				</section>
			</div>

			<div id="listing-stats" class="profile-section-wrapper-custom" style="; float: left;width: 560px; margin: 20px 0 0 30px; padding: 10px 20px 10px 20px; height: 100px;" class="grey">
			</div>
		</div>
		<div class="clearfix"></div>
	</div>
</div>
<div id="overlay">
	<div id="message-container" style="width: 500px; height: 300px; border-radius: 3px; border-color: #404040; border-width: 1px; background-color: #D9D9D9">
		<div id="test" style="width: 500px; height: 300px">
			<div id="message-close" style="float:left; background-color: #FF5454; color: #fff; border-radius: 15px; width: 30px;">X</div>
			<div style="height: 30px; float: left; width: 440px">
				Messaging <%= @listing.user.email %>
			</div>
			<div class="clearfix"></div>
			<div style="max-height: 30px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 440px">
				<span contenteditable="false" style="font-size: 20px; display: inline-block;">Subject: Inquiry about <%= link_to @listing.title, listing_path(@listing) %></span>.
			</div>
	    	<div style="height: 190px; width: 490px;  margin-top:10px; font-size: 14px; overflow-y: scroll; text-align: left;" id="message-text" contenteditable="true">
	    	</div>
	    	<div id="message-send" style="margin-top: 10px" class="abutton">Send</div>
	    	<div id="message-sent" style="display:hidden;">
	    		Message Sent!
	    	</div>
	    </div>
    </div>
</div>
<script>
	var sub_wrapper = $("#sub-wrapper");
	$(window).resize(function(){
		var w = $(window).width();
		var newW = Math.max(10,Math.floor((w-850)/2))+ "px";
		sub_wrapper.css("margin-left", newW);
		sub_wrapper.css("margin-top", "20px")
	});
	$(window).trigger("resize");
	$("#pphoto").hover(function(){
		$("#pphoto .image-heading").slideDown(100).fadeIn(100);
	}, function(){
		$("#pphoto .image-heading").slideUp(100).fadeOut(100);
	});
	var overlay = $("#overlay");
	var message_sent = $("#message-sent");
	var message_send = $("#message-send");
	var message_text = $("#message-text");
	$("#message-lister").click(function(){
		message_send.show();
		message_text.show();
		message_sent.hide();
		overlay.show();
	});
	$("#message-close").click(function(){
		overlay.hide();
	});
	$("#message-send").click(function(){
		var msg = message_text.html();
		message_send.hide();
		message_text.hide();
		message_sent.show();
		message_text.html('');
		overlay.delay(500).fadeOut(600);
		$.ajax({
			url: "<%= messages_path %>"+".json",
			type: "POST",
			data: {
				listing_id: <%= @listing.id %>,
				message : {
					content: msg
				}
			}

		})
	});
</script>

<% if @current_user %>
	<script src="https://checkout.stripe.com/v2/checkout.js"></script>
	<script>
	    $('#rent-listing').click(function(){
	      var token = function(res){
	        $.ajax({
				url: "/users/" + "<%= @current_user.id %>" + "/transactions",
				type: "POST",
				dataType: 'json',
				data: {
					listing_id: <%= @listing.id %>,
					transaction: {
						host_id: <%= @listing.user.id %>,
						renter_id: <%= @current_user.id %>,
						stripeToken : res.id,
						start_date: '2013-02-23',	// TODO(marco): change to actual start date
						end_date: '2013-02-27'		// TODO(marco): change to actual end date
					}
				},
				success: function(data){
				console.log(data)
				}
				});
	      };

	      StripeCheckout.open({
	        key:         'pk_test_jfyQ2QqVi1q5Z8IE0kfwvnpv',
	        address:     true,
	        amount:      "<%= @listing.price %>",
	        name:        "<%= @listing.title %>",
	        description: "<%= @listing.description %>",
	        panelLabel:  'Checkout',
	        token:       token
	      });

	      return false;
	    });
	  </script>
<% end %>